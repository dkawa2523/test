# DINO本番＋SEM‑VLM/SEM‑CLIP支援レイヤー：全体ワークフロー／構成／周辺技術まとめ（Markdownコピペ用）

## 0. 前提（現状想定）

* 1粒子あたり **6枚のSEM画像**（撮像条件が異なる）。
* 6枚のうち **外角（外周）が写っていないビューが多い**（外径が四角く見える等）。
* ユーザーは **カテゴリごとに少数のラベル付き画像（マスター）**を用意。
* マスター・入力画像・確定ラベルは **バックエンドDB**に保存。
* ラベルは「形状・外観」寄りで、**人による揺れ（境界・命名）が大きい**。ラベル名/定義は将来も変わりうる。
* メタデータ（工程/装置/レシピ/ロット/時系列）は当面使わず、将来オプション。

---

## 1. 役割分担の結論（DINO＝確定、VLM＝運用摩擦低減）

### DINO（本番の確定判定レーン）

* 自動ラベル付与（確定ラベルの決定）
* 6枚/粒子の統合（欠けビューの減点・除外）
* 半教師/自己教師で少ラベル強化（必要に応じて）
* Unknown/要確認の制御（運用事故を減らす）

### SEM‑VLM / SEM‑CLIP（支援レイヤー：プロンプト/言語を活かす）

あなたが挙げた4点を主担当にする：

* **テキスト検索**（「言葉で探したい」）
* **ラベル名/定義変更への追従**（同義語・統廃合が多い）
* **要確認の束ね・説明**（レビュー工数削減）
* **6枚/粒子の良いビュー選び支援**（品質タグ）

> 重要な考え方
>
> * VLMは「本番分類器の置き換え」ではなく、**“検索・定義管理・レビュー支援・品質タグ”のレイヤー**として入れると失敗しにくい。
> * 本番の確定判定は DINO に残す（安定性・再現性・責任分界が明確）。

---

## 2. 全体アーキテクチャ（構成）

### 2.1 論理構成（ブロック図）

```
[ユーザーUI]
  ├─ マスター登録（カテゴリ別：少数ラベル画像）
  ├─ 入力（6枚/粒子）登録
  ├─ 自動ラベル結果確認（DINO）
  ├─ 要確認レビュー（束ね・説明）
  └─ テキスト検索（言葉で探す）

        ▼ Backend/API
[画像ストレージ]：生画像/ROI/マスク（任意）
[メタDB]：particle_id/view_id/ラベル履歴/マスター集合/定義文/同義語/モデルver
[ベクトルDB or インデックス]
  ├─ DINO埋め込み（分類・類似検索）
  └─ VLM埋め込み（テキスト検索・束ね・説明）

[モデルサービス]
  ├─ DINO推論（埋め込み、マスター照合、6枚統合、Unknown/要確認判定）
  ├─ VLM推論（画像埋め込み＋テキスト埋め込み、品質/属性タグスコア）
  └─ 品質スコア計算（欠け/ボケ/コントラスト/スケールバー等）
```

### 2.2 DB設計の要点（ラベル揺れ・名称変更に強くする）

* **label_id（不変）**：学習・集計・履歴の主キー（変えない）
* **label_display_name（可変）**：UI表示名（変えてよい）
* **label_definition_text（可変）**：定義文（変えてよい）
* **label_synonyms（可変）**：同義語・言い回し（複数保持）
* **master_set_version**：マスター集合を版管理（いつのマスターで推論したかを残す）

---

## 3. DINO周辺機能の説明と役割（VLMとの統合込み）

| 機能（DINO周辺機能）                       | 何を解決するか                 | DINO側の役割（本番/学習）                 | VLM側の役割（支援）                               | 代表的な実装パターン（段階導入）                                                                | 周辺技術・ライブラリ候補                                             | DBに残すと効くログ                                |
| ---------------------------------- | ----------------------- | ------------------------------- | ----------------------------------------- | ------------------------------------------------------------------------------- | -------------------------------------------------------- | ----------------------------------------- |
| **粒子6枚統合（Multi-view / Set / MIL）** | 外角欠け・撮像差で単一画像分類が不安定     | 6枚→DINO埋め込み→粒子単位へ統合→最終ラベル       | 品質タグ/属性タグを出し、統合重み・説明に利用                   | ①品質ゲート＋重み付き平均（最短）→ ②Deep Sets → ③Attention MIL（寄与可視化）→ ④Set Transformer（相互作用強化） | PyTorch（自作実装が現実的）／OpenCV・scikit-image（品質）                | ビュー別品質スコア、ビュー重み、粒子埋め込み、推奨ビュー、6枚内の予測一貫性    |
| **SSL（Self/Semi-Supervised）**      | 少ラベルで精度向上、未ラベル活用        | 確定済みラベル＋未ラベルを用いた半教師学習／擬似ラベル品質管理 | テキスト検索で「欲しい未ラベル群」を集める／要確認の束ねで誤擬似ラベルを減らす   | FixMatch系→FreeMatch/SoftMatch等へ（擬似ラベル採用を安定化）                                    | SemiLearn/USB系、PyTorch Lightning等（運用に合わせて）               | 擬似ラベルの採否、信頼度、学習データ内訳（L/U比）、モデルver         |
| **ラベル揺れ（曖昧・人依存・誤ラベル耐性）**           | 境界・命名揺れ、誤ラベル混入が学習/運用を壊す | “怪しいラベル”を検出し要確認へ／ノイズに強い学習設計     | 定義文・同義語をDBで管理し、名称揺れを吸収／類似検索で“揺れ塊”を可視化     | ①label_id固定＋定義文運用 ②誤ラベル疑い検出→再確認 ③境界サンプルのみ複数人レビュー                                | cleanlab、FiftyOne（可視化）、Label Studio（レビュー）                | ラベル履歴（誰がいつ変更）、定義文/同義語の版、疑いラベル候補リスト、レビュー結果 |
| **ラベルコスト削減（人手を増やさず回す）**            | 要確認が詰まる、追加ラベルが高コスト      | 自動確定の範囲を制御し要確認を絞る／不確実性で優先順位付け   | 束ね（クラスタ）＋説明でレビュー時間短縮／言葉で検索して必要な追加マスターを集める | ①要確認の理由別キュー ②不確実＋多様性のAL ③クラスタ代表だけ確認                                             | Label Studio（キュー/AL）、FiftyOne Brain（クラスタ/探索）、FAISS（類似検索） | 要確認理由、レビュー時間、修正率、追加マスター履歴、ALで提示した根拠       |

---

## 4. 統合ワークフロー（運用 → レビュー → 継続改善）

### Step A：マスター登録（ユーザー）

1. ユーザーがカテゴリごとに少数のマスター画像を登録
2. バックエンド処理（自動）

   * DINO埋め込み計算（ビュー別＋粒子統合）
   * VLM埋め込み計算（検索/束ね用）
   * 品質スコア計算（欠け/ボケ/コントラスト/スケールバー等）
3. DB・ベクトルインデックスへ保存（版管理）

### Step B：入力（6枚/粒子）→ DINOで自動ラベル付与（本番）

1. 品質スコアで欠けビューを減点/除外
2. DINO埋め込み → 粒子統合 → マスター照合 or ヘッド分類
3. 高信頼は **自動確定**
4. 低信頼・6枚で結論割れ・品質不良は **要確認キュー**

### Step C：要確認レビュー（VLMで“束ね・説明・検索”）

* **束ね**：要確認を埋め込みでクラスタ化し、同類をまとめて提示
* **説明**：品質タグ＋類似マスター＋上位候補拮抗を根拠に提示
* **テキスト検索**：レビュー中に「針状っぽい」「外周欠け」などで追加事例を探索

### Step D：継続改善（ラベル最小で精度を上げる）

* SSLで未ラベル活用（擬似ラベル品質をログで監視）
* ラベル揺れ対策（疑いラベルの優先レビュー、定義文の改善）
* AL（不確実＋多様性）で追加ラベルを最小化
* マスターセットを版管理して改善の効果を追跡

---

## 5. VLM（SEM‑VLM/SEM‑CLIP）が担当する4課題への対応（対応表）

| 課題（VLM役割）                  | 実装する機能                           | 入口（ワークフロー上）               | 期待効果                                | 想定課題           | 対策（安全策）                                |
| -------------------------- | -------------------------------- | ------------------------- | ----------------------------------- | -------------- | -------------------------------------- |
| **言葉で探したい（テキスト検索）**        | Text→Image検索、検索結果の粒子単位統合表示       | UI検索バー→VLMテキスト埋め込み→ベクトル検索 | ラベル無し/揺れ有りでも「欲しい形状」を集められる。マスター補強が速い | プロンプト依存・ドメイン外れ | 同義語プロンプト束ね、定義文テンプレ、検索結果に類似根拠を表示        |
| **ラベル名/定義が頻繁に変わる（統廃合含む）**  | label_id固定＋表示名/定義文/同義語をDB管理（版管理） | ラベル管理画面→即反映               | 名称変更でモデル再学習を避け、分類体系の試行錯誤が可能         | 過去データとの整合      | 版管理、履歴保持、再検索/再集計導線                     |
| **要確認が多くレビュー工数がネック**       | 要確認の束ね（クラスタ）、理由タグ、類似事例提示         | DINOで要確認→VLMで束ね・説明        | “1件ずつ”から“塊で”へ、レビュー時間短縮              | クラスタ混在         | DINO予測カテゴリ/品質でクラスタ条件を制約、代表画像レビューで分割可能に |
| **6枚/粒子で良いビュー選びが負担（品質タグ）** | 外周欠け/ボケ等の品質タグ → 統合重みに反映、推奨ビュー提示  | 推論前の品質評価→統合               | 欠けビューの悪影響を低減し、統合が安定。人の選別負担を削減       | VLM品質タグが不安定    | ルール/画像処理を主、VLMは副（補助）。人の修正ログで品質器改善      |

---

## 6. 周辺技術・ライブラリ（カテゴリ別まとめ：Label Studio/ML backend/FiftyOne Brain等も含む）

> ここは「技術理解しやすい」ように、**カテゴリごとに比較テーブル**を置きます。
> どれも「DINO本番」「VLM支援」の両方に繋がる“運用の土台”です。

### 6.1 アノテーション／レビューUI（人が触る面）

| ツール/手法           | 概要                                   | 強み                              | 弱み/注意                     | この構成での主用途                 |
| ---------------- | ------------------------------------ | ------------------------------- | ------------------------- | ------------------------- |
| **Label Studio** | OSSのアノテ/レビュー基盤。ML backend連携で予測取り込み可能 | 要確認レビューをUI化しやすい。タスク割当・履歴管理がしやすい | ワークフロー設計（キュー/権限/運用ルール）が必要 | 要確認キュー、修正作業、アクティブラーニング提示  |
| CVAT             | OSSのアノテ基盤（検出/セグも強い）                  | 画像アノテが強い（将来セグをやるなら便利）           | 分類のみだとオーバースペックなことも        | 将来ROI/欠け検知の学習データ作り、セグ導入時  |
| 独自Web UI         | 要件に最適化したレビュー画面                       | 最短のUX、現場運用に合わせやすい               | 追加開発が必要                   | 6枚統合の寄与表示、品質タグ、類似事例提示を最適化 |

### 6.2 ML Backend／Active Learning（要確認の出し方を賢くする）

| 手法/ツール                      | 概要                | 強み                       | 弱み/注意              | 主用途                  |
| --------------------------- | ----------------- | ------------------------ | ------------------ | -------------------- |
| **Label Studio ML backend** | 予測→アノテUIへ返す連携     | 既存UIに“予測と優先順位付け”を埋め込みやすい | 実装（API/認証/運用）設計が必要 | DINO低信頼・矛盾・品質不良を優先提示 |
| 不確実性サンプリング                  | 低信頼/高エントロピーを優先ラベル | 実装が簡単で即効性                | 外れ値に吸われる可能性        | まずはこれで要確認を絞る         |
| 多様性サンプリング（埋め込みクラスタ）         | 埋め込み空間の代表を優先      | 似たもの重複を減らす               | クラスタ品質が埋め込み依存      | “マスター補強”に効く          |
| 不確実＋多様性（ハイブリッドAL）           | 上2つを組合せ           | ラベル効率が高い                 | 実装が少し複雑            | 少数ラベルで継続改善の本命        |

### 6.3 データキュレーション／埋め込み可視化（要確認を束ねる・失敗解析）

| ツール/手法                        | 概要                        | 強み                          | 弱み/注意         | 主用途                       |
| ----------------------------- | ------------------------- | --------------------------- | ------------- | ------------------------- |
| **FiftyOne + FiftyOne Brain** | 埋め込み可視化、類似検索、クラスタ、データ品質分析 | “なぜ失敗するか”の探索が強い。束ね・代表例抽出に向く | 導入時にデータ整形が必要  | 要確認の束ね、ラベル揺れの可視化、マスター偏り検出 |
| UMAP（可視化）                     | 高次元埋め込みを2D/3D可視化          | 直感的に分布を見る                   | パラメータで見え方が変わる | DINO/VLM埋め込みの分布確認         |
| HDBSCAN（クラスタ）                 | 密度ベースでクラスタ抽出              | 未知/外れ値の検出に向く                | パラメータ調整が必要    | Unknown候補の束ね・新カテゴリ候補探索    |

### 6.4 ベクトル検索（類似検索・テキスト検索の基盤）

| ツール/手法            | 概要                | 強み            | 弱み/注意        | 主用途                  |
| ----------------- | ----------------- | ------------- | ------------ | -------------------- |
| **FAISS**         | ローカルで高速な近傍検索・クラスタ | 実装が早い、オンプレに強い | 永続化/運用は設計が必要 | DINO/VLM埋め込みの類似検索、束ね |
| pgvector          | Postgres拡張でベクトル検索 | DB一体運用しやすい    | 大規模では設計が要る   | 小～中規模でDB中心に運用        |
| Milvus / Qdrant 等 | ベクトルDB            | スケール/運用機能が豊富  | 導入コストが上がる    | 大規模・分散が必要な場合         |

### 6.5 ラベル揺れ／誤ラベル検出（データ中心の改善）

| ツール/手法        | 概要                  | 強み                 | 弱み/注意        | 主用途               |
| ------------- | ------------------- | ------------------ | ------------ | ----------------- |
| **cleanlab**  | 予測確率等からラベル問題候補を提示   | “疑いラベル”を優先レビューに回せる | 初期モデルが弱いと荒れる | ラベル揺れ検出、誤ラベル混入の監査 |
| 多人数ラベル統合（必要時） | 境界例だけ複数人で付けて整合      | 人依存を数理的に吸収         | 工数が増える       | 境界クラスの定義固め        |
| 定義文運用（VLM）    | ラベルを“名前”でなく“定義文”で管理 | 名称揺れを吸収しやすい        | 定義文のガバナンスが必要 | ラベル体系の安定化         |

### 6.6 実験管理／データ版管理（継続改善の必須土台）

| ツール/手法 | 概要          | 強み           | 弱み/注意          | 主用途                |
| ------ | ----------- | ------------ | -------------- | ------------------ |
| DVC    | データ/モデルの版管理 | 再現性・監査性を確保   | 運用ルールが必要       | マスターセット版管理、学習データ追跡 |
| MLflow | 実験管理・モデル管理  | どのモデルが良いか追える | 導入設計が必要        | モデル比較、しきい値管理       |
| W&B    | 実験ログ可視化     | 分析が速い        | 外部SaaS利用ポリシー注意 | 学習/評価の可視化          |

### 6.7 推論API／デプロイ（現場で使う）

| ツール/手法                  | 概要         | 強み         | 弱み/注意       | 主用途                |
| ----------------------- | ---------- | ---------- | ----------- | ------------------ |
| FastAPI                 | PythonでAPI | 最短で組める     | 推論スケールは別途設計 | DINO/VLM/品質器の推論API |
| ONNX Runtime            | 推論高速化      | CPU/GPU両対応 | 変換互換性注意     | 推論コスト削減            |
| Triton Inference Server | 推論サービング基盤  | スケール/管理が強い | 導入がやや重い     | 本番で高スループットが必要な場合   |

---

## 7. まとめ（第三者向け一文）

* **DINOで確定ラベル付与を安定運用**し、
* **SEM‑VLM/SEM‑CLIPを“言語検索・定義変更追従・要確認の束ね/説明・品質タグ”に特化**して組み合わせ、
* さらに **6枚統合／SSL／ラベル揺れ耐性／ラベルコスト削減**を運用ループとして回すことで、
  **少数マスター運用を維持したまま、精度と現場の回しやすさ（レビュー工数・分類体系変更耐性）を同時に上げる**構成です。

---

## 8. 次に具体化すると良い“最小実装順”（おすすめ）

1. **品質スコア（欠け/ボケ）＋重み付き平均で6枚統合**（DINO本番をまず安定化）
2. **要確認キュー**を作り、Label Studio等でレビュー可能にする
3. **VLM埋め込み＋FAISS**で

   * テキスト検索
   * 要確認束ね（クラスタ）
   * 類似事例提示
     を入れる（レビュー時間が落ちるかを検証）
4. 伸びが必要なら **SSL（SemiLearn等）**と **cleanlab**を追加して継続改善を仕組みにする

---

必要なら、あなたの現行方式（マスター照合がkNNなのかプロトタイプ平均なのか、要確認しきい値、6枚統合の現状）に合わせて、

* **粒子embeddingの具体定義（6枚統合式）**
* **要確認ルール（DINO信頼度×品質×VLM矛盾）**
* **DBスキーマ（テーブル/索引/版管理）**
  を、そのまま開発タスクに切れる粒度で作成します。
